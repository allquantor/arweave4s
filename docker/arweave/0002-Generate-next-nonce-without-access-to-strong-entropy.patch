From 99aff57a332a10d5ae0ad74e5ee5c9397b7dab92 Mon Sep 17 00:00:00 2001
From: Gustav Behm <gustav@upvest.co>
Date: Sun, 13 May 2018 13:38:14 +0200
Subject: [PATCH 2/2] Generate next nonce without access to strong entropy

---
 src/ar_mine.erl | 21 +++++++++++++++------
 1 file changed, 15 insertions(+), 6 deletions(-)

diff --git a/src/ar_mine.erl b/src/ar_mine.erl
index 5f629ff..e954e88 100644
--- a/src/ar_mine.erl
+++ b/src/ar_mine.erl
@@ -13,7 +13,8 @@
 	diff,
 	data,
 	delay,
-	txs
+	txs,
+	nonce
 }).
 
 %% @doc Returns the PID of a new mining worker process.
@@ -33,7 +34,8 @@ start(Hash, Diff, Data, Delay, TXs) ->
 						diff = Diff,
 						data = Data,
 						delay = Delay,
-						txs = TXs
+						txs = TXs,
+						nonce = <<>>
 					}
 				)
 			)
@@ -55,7 +57,8 @@ server(
 		hash = Hash,
 		diff = Diff,
 		data = Data,
-		txs = TXs
+		txs = TXs,
+		nonce = Nonce
 	}) ->
 	receive
 		stop ->
@@ -70,8 +73,10 @@ server(
 			);
 		hash ->
 			schedule_hash(S),
-			case validate(Hash, Diff, Data, Nonce = generate()) of
-				false -> server(S);
+			case validate(Hash, Diff, Data, Nonce) of
+				false ->
+					MoreNonce = generate(),
+					server(S#state { nonce = <<MoreNonce/binary, Nonce/binary>> });
 				NextHash ->
 					%ar:report_console([{miner, self()}, {found_block, Nonce}]),
 					Parent ! {work_complete, TXs, Hash, NextHash, Diff, Nonce},
@@ -97,7 +102,11 @@ schedule_hash(S = #state { delay = Delay }) ->
 	S.
 
 %% @doc Generate a random nonce, to be added to the previous hash.
-generate() -> crypto:strong_rand_bytes(8).
+generate() ->
+	case rand:uniform(2) of
+		1 -> <<0>>;
+		2 -> <<1>>
+	end.
 
 %%% Tests
 
-- 
2.17.0

