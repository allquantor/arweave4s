From d52f2c60524dbb3b8d6c86c4c38108241588403b Mon Sep 17 00:00:00 2001
From: Gustav Behm <gustav@upvest.co>
Date: Sun, 13 May 2018 13:38:14 +0200
Subject: [PATCH 2/2] Generate next nonce without access to strong entropy

---
 src/ar_mine.erl  | 21 ++++++++++++++-------
 src/ar_weave.erl |  5 +----
 2 files changed, 15 insertions(+), 11 deletions(-)

diff --git a/src/ar_mine.erl b/src/ar_mine.erl
index 5f629ff..2d22a01 100644
--- a/src/ar_mine.erl
+++ b/src/ar_mine.erl
@@ -13,7 +13,8 @@
 	diff,
 	data,
 	delay,
-	txs
+	txs,
+	nonces
 }).
 
 %% @doc Returns the PID of a new mining worker process.
@@ -33,7 +34,8 @@ start(Hash, Diff, Data, Delay, TXs) ->
 						diff = Diff,
 						data = Data,
 						delay = Delay,
-						txs = TXs
+						txs = TXs,
+						nonces = []
 					}
 				)
 			)
@@ -55,7 +57,8 @@ server(
 		hash = Hash,
 		diff = Diff,
 		data = Data,
-		txs = TXs
+		txs = TXs,
+		nonces = Nonces
 	}) ->
 	receive
 		stop ->
@@ -70,8 +73,9 @@ server(
 			);
 		hash ->
 			schedule_hash(S),
-			case validate(Hash, Diff, Data, Nonce = generate()) of
-				false -> server(S);
+			Nonce = iolist_to_binary(Nonces),
+			case validate(Hash, Diff, Data, Nonces) of
+				false -> server(S#state { nonces = [coinflip()|Nonces] });
 				NextHash ->
 					%ar:report_console([{miner, self()}, {found_block, Nonce}]),
 					Parent ! {work_complete, TXs, Hash, NextHash, Diff, Nonce},
@@ -96,8 +100,11 @@ schedule_hash(S = #state { delay = Delay }) ->
 	spawn(fun() -> receive after ar:scale_time(Delay) -> Parent ! hash end end),
 	S.
 
-%% @doc Generate a random nonce, to be added to the previous hash.
-generate() -> crypto:strong_rand_bytes(8).
+coinflip() ->
+	case rand:uniform(2) of
+		1 -> <<0>>;
+		2 -> <<1>>
+	end.
 
 %%% Tests
 
diff --git a/src/ar_weave.erl b/src/ar_weave.erl
index 237dafc..d5ccd53 100644
--- a/src/ar_weave.erl
+++ b/src/ar_weave.erl
@@ -144,10 +144,7 @@ generate_block_data(TXs) ->
 hash(B, TXs, Nonce) when is_record(B, block) ->
 	hash(B#block.hash, generate_block_data(TXs), Nonce);
 hash(Hash, TXs, Nonce) ->
-	crypto:hash(
-		?HASH_ALG,
-		<< Nonce/binary, Hash/binary, TXs/binary >>
-	).
+	crypto:hash(?HASH_ALG, erlang:iolist_to_iovec([Nonce, Hash, TXs])).
 
 %% @doc Create an independent hash from a block. Independent hashes
 %% verify a block's contents in isolation and are stored in a node's hash list.
-- 
2.17.0

